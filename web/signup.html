<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sign Up - HomeOps</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              50: '#f0fdf4',
              100: '#dcfce7',
              200: '#bbf7d0',
              300: '#86efac',
              400: '#4ade80',
              500: '#22c55e',
              600: '#16a34a',
              700: '#15803d',
              800: '#166534',
              900: '#14532d',
            }
          }
        }
      }
    }
  </script>
  <style>
    .plan-card {
      transition: all 0.2s ease;
    }
    .plan-card:hover {
      transform: translateY(-2px);
    }
    .plan-card.selected {
      border-color: #16a34a;
      background-color: #f0fdf4;
    }
    .member-item {
      animation: slideIn 0.2s ease;
    }
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Header -->
  <header class="bg-white border-b border-gray-200">
    <div class="max-w-3xl mx-auto px-4 py-4">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-brand-600 rounded-lg flex items-center justify-center">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
          </svg>
        </div>
        <div>
          <h1 class="text-xl font-bold text-gray-900">HomeOps</h1>
          <p class="text-sm text-gray-500">Household Operations Assistant</p>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-3xl mx-auto px-4 py-8">
    <div class="text-center mb-8">
      <h2 class="text-2xl font-bold text-gray-900 mb-2">Create Your Household</h2>
      <p class="text-gray-600">Set up your household and start managing tasks via WhatsApp</p>
    </div>

    <form id="signupForm" class="space-y-8">
      <!-- Step 1: Subscriber Info -->
      <section class="bg-white rounded-xl border border-gray-200 p-6">
        <div class="flex items-center gap-3 mb-6">
          <span class="w-8 h-8 bg-brand-100 text-brand-700 rounded-full flex items-center justify-center font-semibold text-sm">1</span>
          <h3 class="text-lg font-semibold text-gray-900">Your Information</h3>
        </div>

        <div class="grid gap-4 sm:grid-cols-2">
          <div class="sm:col-span-2">
            <label for="subscriberName" class="block text-sm font-medium text-gray-700 mb-1">Your Name *</label>
            <input type="text" id="subscriberName" name="subscriber_name" required
              class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition"
              placeholder="Enter your full name">
          </div>

          <div>
            <label for="subscriberWhatsapp" class="block text-sm font-medium text-gray-700 mb-1">WhatsApp Number *</label>
            <input type="tel" id="subscriberWhatsapp" name="subscriber_whatsapp" required
              class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition"
              placeholder="+92 300 1234567">
            <p class="text-xs text-gray-500 mt-1">Include country code (e.g., +92)</p>
          </div>

          <div>
            <label for="subscriberEmail" class="block text-sm font-medium text-gray-700 mb-1">Email Address *</label>
            <input type="email" id="subscriberEmail" name="subscriber_email" required
              class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition"
              placeholder="you@example.com">
          </div>
        </div>
      </section>

      <!-- Step 2: Household Info -->
      <section class="bg-white rounded-xl border border-gray-200 p-6">
        <div class="flex items-center gap-3 mb-6">
          <span class="w-8 h-8 bg-brand-100 text-brand-700 rounded-full flex items-center justify-center font-semibold text-sm">2</span>
          <h3 class="text-lg font-semibold text-gray-900">Household Details</h3>
        </div>

        <div class="grid gap-4 sm:grid-cols-2">
          <div class="sm:col-span-2">
            <label for="householdName" class="block text-sm font-medium text-gray-700 mb-1">Household Name *</label>
            <input type="text" id="householdName" name="household_name" required
              class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition"
              placeholder="e.g., The Khan Family">
          </div>

          <div>
            <label for="timezone" class="block text-sm font-medium text-gray-700 mb-1">Timezone</label>
            <select id="timezone" name="timezone"
              class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition bg-white">
              <option value="Asia/Karachi" selected>Pakistan (PKT)</option>
              <option value="Asia/Dubai">UAE (GST)</option>
              <option value="Asia/Kolkata">India (IST)</option>
              <option value="Europe/London">UK (GMT/BST)</option>
              <option value="America/New_York">US Eastern</option>
              <option value="America/Los_Angeles">US Pacific</option>
            </select>
          </div>

          <div>
            <label for="language" class="block text-sm font-medium text-gray-700 mb-1">Preferred Language</label>
            <select id="language" name="language_pref"
              class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition bg-white">
              <option value="en" selected>English</option>
              <option value="ur">Urdu</option>
            </select>
          </div>

          <div class="sm:col-span-2">
            <label for="address" class="block text-sm font-medium text-gray-700 mb-1">Address (Optional)</label>
            <textarea id="address" name="address" rows="2"
              class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition resize-none"
              placeholder="Enter your address"></textarea>
          </div>
        </div>
      </section>

      <!-- Step 3: Members -->
      <section class="bg-white rounded-xl border border-gray-200 p-6">
        <div class="flex items-center justify-between mb-6">
          <div class="flex items-center gap-3">
            <span class="w-8 h-8 bg-brand-100 text-brand-700 rounded-full flex items-center justify-center font-semibold text-sm">3</span>
            <div>
              <h3 class="text-lg font-semibold text-gray-900">Household Members & Staff</h3>
              <p class="text-sm text-gray-500">Add family members and household staff</p>
            </div>
          </div>
          <span id="memberCount" class="text-sm text-gray-500">0 people</span>
        </div>

        <div id="membersContainer" class="space-y-4 mb-4">
          <!-- Members will be added here -->
        </div>

        <button type="button" id="addMemberBtn"
          class="w-full py-3 border-2 border-dashed border-gray-300 rounded-lg text-gray-600 hover:border-brand-500 hover:text-brand-600 transition flex items-center justify-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
          </svg>
          Add Person
        </button>

        <p id="memberLimitWarning" class="text-sm text-amber-600 mt-3 hidden">
          You've reached the limit for your selected plan. Upgrade to add more people.
        </p>
      </section>

      <!-- Step 4: Plan Selection -->
      <section class="bg-white rounded-xl border border-gray-200 p-6">
        <div class="flex items-center gap-3 mb-6">
          <span class="w-8 h-8 bg-brand-100 text-brand-700 rounded-full flex items-center justify-center font-semibold text-sm">4</span>
          <h3 class="text-lg font-semibold text-gray-900">Choose Your Plan</h3>
        </div>

        <div class="grid gap-4 sm:grid-cols-3">
          <!-- Starter Plan -->
          <label class="plan-card cursor-pointer block border-2 border-gray-200 rounded-xl p-4 hover:border-brand-300">
            <input type="radio" name="selected_plan" value="starter" class="sr-only" checked>
            <div class="text-center">
              <h4 class="font-semibold text-gray-900 mb-1">Starter</h4>
              <p class="text-3xl font-bold text-gray-900 mb-1">PKR 15,000</p>
              <p class="text-sm text-gray-500 mb-4">/month</p>
              <ul class="text-sm text-gray-600 space-y-2">
                <li class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-brand-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                  </svg>
                  Up to 3 members
                </li>
                <li class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-brand-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                  </svg>
                  Unlimited tasks
                </li>
                <li class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-brand-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                  </svg>
                  WhatsApp support
                </li>
              </ul>
            </div>
            <div class="mt-4 pt-4 border-t border-gray-100">
              <div class="w-full py-2 bg-gray-100 rounded-lg text-center text-sm font-medium text-gray-700 plan-button">
                Selected
              </div>
            </div>
          </label>

          <!-- Family Plan -->
          <label class="plan-card cursor-pointer block border-2 border-gray-200 rounded-xl p-4 hover:border-brand-300 relative">
            <div class="absolute -top-3 left-1/2 -translate-x-1/2 bg-brand-500 text-white text-xs font-semibold px-3 py-1 rounded-full">
              Popular
            </div>
            <input type="radio" name="selected_plan" value="family" class="sr-only">
            <div class="text-center">
              <h4 class="font-semibold text-gray-900 mb-1">Family</h4>
              <p class="text-3xl font-bold text-gray-900 mb-1">PKR 25,000</p>
              <p class="text-sm text-gray-500 mb-4">/month</p>
              <ul class="text-sm text-gray-600 space-y-2">
                <li class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-brand-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                  </svg>
                  Up to 6 members
                </li>
                <li class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-brand-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                  </svg>
                  Unlimited tasks
                </li>
                <li class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-brand-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                  </svg>
                  Priority support
                </li>
              </ul>
            </div>
            <div class="mt-4 pt-4 border-t border-gray-100">
              <div class="w-full py-2 bg-gray-100 rounded-lg text-center text-sm font-medium text-gray-700 plan-button">
                Select Plan
              </div>
            </div>
          </label>

          <!-- Premium Plan -->
          <label class="plan-card cursor-pointer block border-2 border-gray-200 rounded-xl p-4 hover:border-brand-300">
            <input type="radio" name="selected_plan" value="premium" class="sr-only">
            <div class="text-center">
              <h4 class="font-semibold text-gray-900 mb-1">Premium</h4>
              <p class="text-3xl font-bold text-gray-900 mb-1">PKR 35,000</p>
              <p class="text-sm text-gray-500 mb-4">/month</p>
              <ul class="text-sm text-gray-600 space-y-2">
                <li class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-brand-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                  </svg>
                  Up to 12 members
                </li>
                <li class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-brand-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                  </svg>
                  Unlimited tasks
                </li>
                <li class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-brand-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                  </svg>
                  Dedicated support
                </li>
              </ul>
            </div>
            <div class="mt-4 pt-4 border-t border-gray-100">
              <div class="w-full py-2 bg-gray-100 rounded-lg text-center text-sm font-medium text-gray-700 plan-button">
                Select Plan
              </div>
            </div>
          </label>
        </div>

        <input type="hidden" name="billing_cycle" value="monthly">
      </section>

      <!-- Submit -->
      <div id="formSection" class="bg-white rounded-xl border border-gray-200 p-6">
        <div id="formError" class="hidden mb-4 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm"></div>

        <button type="submit" id="submitBtn"
          class="w-full py-3 bg-brand-600 hover:bg-brand-700 text-white font-semibold rounded-lg transition flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
          <span id="submitText">Create Household</span>
          <svg id="submitSpinner" class="hidden w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        </button>

        <p class="text-center text-sm text-gray-500 mt-4">
          By signing up, you agree to our
          <a href="#" class="text-brand-600 hover:underline">Terms of Service</a> and
          <a href="#" class="text-brand-600 hover:underline">Privacy Policy</a>
        </p>
      </div>

      <!-- Success Message (hidden by default) -->
      <div id="successSection" class="hidden bg-white rounded-xl border border-gray-200 p-6">
        <div class="text-center">
          <div class="w-16 h-16 bg-brand-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-brand-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
          </div>
          <h3 id="successTitle" class="text-xl font-bold text-gray-900 mb-2">Success!</h3>
          <div id="successMessage" class="text-gray-600 mb-6"></div>
          <a href="/" class="inline-block px-6 py-2 bg-brand-600 hover:bg-brand-700 text-white font-medium rounded-lg transition">
            Back to Home
          </a>
        </div>
      </div>
    </form>
  </main>

  <!-- Footer -->
  <footer class="border-t border-gray-200 mt-16">
    <div class="max-w-3xl mx-auto px-4 py-6 text-center text-sm text-gray-500">
      <p>&copy; 2024 HomeOps. All rights reserved.</p>
    </div>
  </footer>

  <script>
    // Configuration
    const API_ENDPOINT = 'http://178.128.208.39/webhook/signup-form';
    const PLAN_LIMITS = {
      starter: 3,
      family: 6,
      premium: 12
    };

    // State
    let members = [];
    let selectedPlan = 'starter';

    // DOM Elements
    const form = document.getElementById('signupForm');
    const membersContainer = document.getElementById('membersContainer');
    const addMemberBtn = document.getElementById('addMemberBtn');
    const memberCount = document.getElementById('memberCount');
    const memberLimitWarning = document.getElementById('memberLimitWarning');
    const planCards = document.querySelectorAll('.plan-card');
    const planInputs = document.querySelectorAll('input[name="selected_plan"]');
    const submitBtn = document.getElementById('submitBtn');
    const submitText = document.getElementById('submitText');
    const submitSpinner = document.getElementById('submitSpinner');
    const formError = document.getElementById('formError');
    const formSection = document.getElementById('formSection');
    const successSection = document.getElementById('successSection');
    const successTitle = document.getElementById('successTitle');
    const successMessage = document.getElementById('successMessage');

    // Initialize
    function init() {
      // Pre-fill phone from URL params
      const urlParams = new URLSearchParams(window.location.search);
      const phone = urlParams.get('phone');
      if (phone) {
        document.getElementById('subscriberWhatsapp').value = decodeURIComponent(phone);
      }

      // Plan selection
      planInputs.forEach(input => {
        input.addEventListener('change', (e) => {
          selectedPlan = e.target.value;
          updatePlanUI();
          checkMemberLimit();
        });
      });

      // Add member button
      addMemberBtn.addEventListener('click', addMember);

      // Form submission
      form.addEventListener('submit', handleSubmit);

      // Initial UI update
      updatePlanUI();
    }

    function updatePlanUI() {
      planCards.forEach(card => {
        const input = card.querySelector('input[name="selected_plan"]');
        const button = card.querySelector('.plan-button');

        if (input.checked) {
          card.classList.add('selected');
          button.textContent = 'Selected';
          button.classList.remove('bg-gray-100', 'text-gray-700');
          button.classList.add('bg-brand-600', 'text-white');
        } else {
          card.classList.remove('selected');
          button.textContent = 'Select Plan';
          button.classList.add('bg-gray-100', 'text-gray-700');
          button.classList.remove('bg-brand-600', 'text-white');
        }
      });
    }

    function addMember() {
      const limit = PLAN_LIMITS[selectedPlan];
      // Subscriber counts as 1, so members can be limit - 1
      if (members.length >= limit - 1) {
        memberLimitWarning.classList.remove('hidden');
        return;
      }

      const memberId = Date.now();
      members.push({ id: memberId, name: '', whatsapp: '', role: 'member', language_pref: 'en' });

      const memberHtml = `
        <div class="member-item border border-gray-200 rounded-lg p-4" data-member-id="${memberId}">
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-4">
              <span class="text-sm font-medium text-gray-700">Person ${members.length}</span>
              <!-- Role toggle -->
              <div class="flex gap-3">
                <label class="flex items-center gap-1.5 cursor-pointer">
                  <input type="radio" name="role_${memberId}" value="member" checked
                    class="member-role w-4 h-4 text-brand-600 focus:ring-brand-500" data-member-id="${memberId}">
                  <span class="text-sm text-gray-600">Family</span>
                </label>
                <label class="flex items-center gap-1.5 cursor-pointer">
                  <input type="radio" name="role_${memberId}" value="staff"
                    class="member-role w-4 h-4 text-brand-600 focus:ring-brand-500" data-member-id="${memberId}">
                  <span class="text-sm text-gray-600">Staff</span>
                </label>
              </div>
            </div>
            <button type="button" class="remove-member text-gray-400 hover:text-red-500 transition" data-member-id="${memberId}">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          <div class="grid gap-3 sm:grid-cols-3">
            <div>
              <input type="text" class="member-name w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition"
                placeholder="Name" data-member-id="${memberId}">
            </div>
            <div>
              <input type="tel" class="member-whatsapp w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition"
                placeholder="WhatsApp (+92...)" data-member-id="${memberId}">
            </div>
            <div class="member-language-container hidden" data-member-id="${memberId}">
              <select class="member-language w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition bg-white"
                data-member-id="${memberId}">
                <option value="en">English</option>
                <option value="ur">Urdu</option>
              </select>
            </div>
          </div>
        </div>
      `;

      membersContainer.insertAdjacentHTML('beforeend', memberHtml);
      updateMemberCount();
      checkMemberLimit();

      // Add event listeners to new member inputs
      const memberEl = membersContainer.querySelector(`[data-member-id="${memberId}"]`);
      memberEl.querySelector('.member-name').addEventListener('input', (e) => {
        const member = members.find(m => m.id === memberId);
        if (member) member.name = e.target.value;
      });
      memberEl.querySelector('.member-whatsapp').addEventListener('input', (e) => {
        const member = members.find(m => m.id === memberId);
        if (member) member.whatsapp = e.target.value;
      });
      memberEl.querySelector('.member-language').addEventListener('change', (e) => {
        const member = members.find(m => m.id === memberId);
        if (member) member.language_pref = e.target.value;
      });

      // Role toggle event listeners
      const roleInputs = memberEl.querySelectorAll('.member-role');
      roleInputs.forEach(input => {
        input.addEventListener('change', (e) => {
          const member = members.find(m => m.id === memberId);
          if (member) {
            member.role = e.target.value;
            // Show/hide language dropdown based on role
            const langContainer = memberEl.querySelector('.member-language-container');
            if (e.target.value === 'staff') {
              langContainer.classList.remove('hidden');
            } else {
              langContainer.classList.add('hidden');
            }
          }
        });
      });

      memberEl.querySelector('.remove-member').addEventListener('click', () => removeMember(memberId));
    }

    function removeMember(memberId) {
      members = members.filter(m => m.id !== memberId);
      const memberEl = membersContainer.querySelector(`[data-member-id="${memberId}"]`);
      if (memberEl) memberEl.remove();
      updateMemberCount();
      checkMemberLimit();

      // Update person numbers
      const memberItems = membersContainer.querySelectorAll('.member-item');
      memberItems.forEach((item, index) => {
        item.querySelector('.text-sm.font-medium').textContent = `Person ${index + 1}`;
      });
    }

    function updateMemberCount() {
      const count = members.length;
      const staffCount = members.filter(m => m.role === 'staff').length;
      const memberCountNum = count - staffCount;

      let text = '';
      if (memberCountNum > 0) text += `${memberCountNum} family`;
      if (staffCount > 0) {
        if (text) text += ', ';
        text += `${staffCount} staff`;
      }
      if (!text) text = '0 people';

      memberCount.textContent = text;
    }

    function checkMemberLimit() {
      const limit = PLAN_LIMITS[selectedPlan];
      // Subscriber counts as 1
      if (members.length >= limit - 1) {
        addMemberBtn.classList.add('opacity-50', 'cursor-not-allowed');
        memberLimitWarning.classList.remove('hidden');
      } else {
        addMemberBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        memberLimitWarning.classList.add('hidden');
      }
    }

    function normalizePhone(phone) {
      // Remove spaces, dashes, parentheses
      let normalized = phone.replace(/[\s\-\(\)]/g, '');

      // Ensure starts with +
      if (!normalized.startsWith('+')) {
        // Assume Pakistan if no country code
        if (normalized.startsWith('0')) {
          normalized = '+92' + normalized.substring(1);
        } else {
          normalized = '+' + normalized;
        }
      }

      return normalized;
    }

    function validatePhone(phone) {
      const normalized = normalizePhone(phone);
      // Basic E.164 validation: + followed by 10-15 digits
      return /^\+[1-9]\d{9,14}$/.test(normalized);
    }

    function showError(message) {
      formError.textContent = message;
      formError.classList.remove('hidden');
      formError.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function hideError() {
      formError.classList.add('hidden');
    }

    function setLoading(loading) {
      submitBtn.disabled = loading;
      submitText.textContent = loading ? 'Processing...' : 'Create Household';
      submitSpinner.classList.toggle('hidden', !loading);
    }

    function showSuccess(title, message) {
      // Hide form, show success
      form.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
      formSection.classList.add('hidden');
      successSection.classList.remove('hidden');
      successTitle.textContent = title;
      successMessage.innerHTML = message;
      successSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    async function handleSubmit(e) {
      e.preventDefault();
      hideError();

      // Validate subscriber phone
      const subscriberWhatsapp = document.getElementById('subscriberWhatsapp').value;
      if (!validatePhone(subscriberWhatsapp)) {
        showError('Please enter a valid WhatsApp number with country code (e.g., +92 300 1234567)');
        return;
      }

      // Validate member phones
      const validMembers = members.filter(m => m.name.trim() && m.whatsapp.trim());
      for (const member of validMembers) {
        if (!validatePhone(member.whatsapp)) {
          showError(`Please enter a valid WhatsApp number for ${member.name || 'person'}`);
          return;
        }
      }

      // Build form data (nested structure for workflow)
      const formData = {
        subscriber: {
          name: document.getElementById('subscriberName').value.trim(),
          whatsapp: normalizePhone(subscriberWhatsapp),
          email: document.getElementById('subscriberEmail').value.trim()
        },
        household: {
          name: document.getElementById('householdName').value.trim(),
          timezone: document.getElementById('timezone').value,
          address: document.getElementById('address').value.trim()
        },
        plan: selectedPlan,
        language: document.getElementById('language').value,
        members: validMembers.map(m => ({
          name: m.name.trim(),
          whatsapp: normalizePhone(m.whatsapp),
          role: m.role,
          language_pref: m.role === 'staff' ? m.language_pref : undefined
        }))
      };

      setLoading(true);

      try {
        const response = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || data.message || 'Something went wrong');
        }

        // Handle response based on status
        if (data.status === 'activated') {
          // Whitelisted user - immediately activated
          showSuccess(
            'Welcome to HomeOps!',
            `<p class="mb-4">Your household <strong>"${formData.household.name}"</strong> is now active.</p>
            <p class="mb-4">You can start using HomeOps via WhatsApp immediately!</p>
            <p class="text-sm text-gray-500">Send a message to our WhatsApp number to get started.</p>`
          );
        } else if (data.status === 'awaiting_payment') {
          // Non-whitelisted user - awaiting manual activation
          showSuccess(
            'Thank You for Signing Up!',
            `<p class="mb-4">Your signup for <strong>"${formData.household.name}"</strong> is pending activation.</p>
            <div class="bg-gray-50 rounded-lg p-4 mb-4 text-left">
              <p class="font-medium text-gray-900 mb-2">Please complete payment via:</p>
              <ul class="text-sm text-gray-600 space-y-1">
                <li><strong>JazzCash:</strong> ${data.payment_jazzcash || '03XX-XXXXXXX'}</li>
                <li><strong>EasyPaisa:</strong> ${data.payment_easypaisa || '03XX-XXXXXXX'}</li>
                <li><strong>Bank Transfer:</strong> ${data.payment_bank || 'Contact for details'}</li>
              </ul>
            </div>
            <p class="text-sm text-gray-500">Once payment is confirmed, your household will be activated within 24 hours. You'll receive a WhatsApp message when ready.</p>`
          );
        } else {
          throw new Error('Unexpected response from server');
        }
      } catch (error) {
        console.error('Signup error:', error);
        showError(error.message || 'Failed to process signup. Please try again.');
        setLoading(false);
      }
    }

    // Initialize on DOM ready
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
